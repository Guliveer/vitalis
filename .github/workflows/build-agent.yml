# =============================================================================
# Vitalis Build Agent Download Binaries
# =============================================================================
# Cross-compiles the agent with the generic config and commits the binaries
# to web/public/downloads/ so the download API can serve them.
#
# Triggers:
#   - Push to main when agent/ files change
#   - Manual dispatch with optional version override
#   - Release published (also uploads binaries as release assets)

name: "Build Agent Download Binaries"

on:
  push:
    branches: [main]
    paths:
      - "agent/**"
      - "build-downloads.sh"
      - ".github/workflows/build-agent.yml"
  workflow_dispatch:
    inputs:
      version:
        description: "Version string to embed in the binaries"
        required: false
        default: ""
  release:
    types: [published]

concurrency:
  group: build-agent-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: Build Agent Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: agent/go.sum

      - name: Build agent binaries
        run: |
          chmod +x build-downloads.sh
          if [ -n "${{ github.event.inputs.version }}" ]; then
            ./build-downloads.sh --version "${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            ./build-downloads.sh --version "${{ github.event.release.tag_name }}"
          else
            ./build-downloads.sh
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vitalis-agent-binaries
          path: web/public/downloads/vitalis-agent-*
          retention-days: 30

      - name: Commit binaries to repository
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add web/public/downloads/
          if ! git diff --cached --quiet; then
            git commit -m "chore: update pre-built agent binaries [skip ci]"
            git push
          else
            echo "No changes to commit â€” binaries are up to date"
          fi

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: web/public/downloads/vitalis-agent-*
